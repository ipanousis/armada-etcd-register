
#!/usr/bin/python

import etcd
import sys
from urlparse import urlparse

etcd_host = "{{ .Env.ETCD_HOST }}"
if not etcd_host:
    print "ETCD_HOST not set"
    sys.exit(1)

port = 4001
host = etcd_host

if ":" in etcd_host:
    host, port = etcd_host.split(":")

client = etcd.Client(host=host, port=int(port))

try:
    backends = client.read("/backends")
except KeyError:
    client.write("/backends", None, dir=True)

{{ $local := . }}
{{range $key, $value := .}}

# {{ $value.Name }}
{{ $tag := "latest" }}
{{ if $value.Image.Tag }}
{{ $tag := $value.Image.Tag }}
{{end}}

running_container = {
                      "host"       : "{{ $local.Env.HOST_IP }}",
                      "container_id" : "{{ printf "%.*s" 24 $value.ID }}",
                      "registry"   : "{{ $value.Image.Registry }}",
                      "repository" : "{{ $value.Image.Repository }}",
                      "tag"        : "{{ $tag }}",
                      "addresses"  : "{{ $value.Addresses }}"
                    }

client.write("/backends/{{ $local.Env.HOST_IP }}/{{ printf "%.*s" 24 $value.ID }}", running_container, ttl=15)

{{end}}
